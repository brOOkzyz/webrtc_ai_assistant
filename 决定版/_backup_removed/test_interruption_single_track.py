#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æµ‹è¯•æ‰“æ–­æœºåˆ¶ä¸­çš„å•è½¨é“æ’­æ”¾åŠŸèƒ½
éªŒè¯æ‰“æ–­æ—¶æ˜¯å¦è¿˜ä¼šå‡ºç°å¤šè½¨é“éŸ³é¢‘é‡å çš„é—®é¢˜
"""

import time
import threading
import sys
import os

# æ·»åŠ å½“å‰ç›®å½•åˆ°è·¯å¾„
sys.path.insert(0, os.path.dirname(__file__))

def test_interruption_single_track():
    """æµ‹è¯•æ‰“æ–­æœºåˆ¶ä¸­çš„å•è½¨é“æ’­æ”¾åŠŸèƒ½"""
    print("ğŸ§ª æµ‹è¯•æ‰“æ–­æœºåˆ¶ä¸­çš„å•è½¨é“æ’­æ”¾åŠŸèƒ½")
    print("=" * 60)
    
    try:
        # å¯¼å…¥ä¿®å¤åçš„æ¨¡å—
        from asr_llm_working import (
            force_reset_all_tts_state,
            stop_single_tts_instance,
            ensure_single_tts_instance,
            is_tts_playing,
            _tts_singleton_instance,
            _tts_is_playing
        )
        
        print("âœ… æˆåŠŸå¯¼å…¥ä¿®å¤åçš„æ¨¡å—")
        
        # æµ‹è¯•1ï¼šTTSçŠ¶æ€é‡ç½®åŠŸèƒ½
        print("\nğŸ” æµ‹è¯•1ï¼šTTSçŠ¶æ€é‡ç½®åŠŸèƒ½")
        try:
            print("ğŸ”„ æµ‹è¯•å¼ºåˆ¶é‡ç½®æ‰€æœ‰TTSçŠ¶æ€...")
            force_reset_all_tts_state()
            print("âœ… TTSçŠ¶æ€é‡ç½®æµ‹è¯•æˆåŠŸ")
        except Exception as e:
            print(f"âŒ TTSçŠ¶æ€é‡ç½®æµ‹è¯•å¤±è´¥: {e}")
        
        # æµ‹è¯•2ï¼šTTSå•ä¾‹å®ä¾‹ç®¡ç†
        print("\nğŸ” æµ‹è¯•2ï¼šTTSå•ä¾‹å®ä¾‹ç®¡ç†")
        try:
            print("ğŸ”„ æµ‹è¯•å¯åŠ¨TTSå•ä¾‹å®ä¾‹...")
            result = ensure_single_tts_instance()
            print(f"âœ… TTSå•ä¾‹å®ä¾‹å¯åŠ¨ç»“æœ: {result}")
            
            # æ£€æŸ¥å•ä¾‹çŠ¶æ€
            print(f"ğŸ” å½“å‰å•ä¾‹çŠ¶æ€: _tts_singleton_instance={_tts_singleton_instance}, _tts_is_playing={_tts_is_playing}")
            
        except Exception as e:
            print(f"âŒ TTSå•ä¾‹å®ä¾‹ç®¡ç†æµ‹è¯•å¤±è´¥: {e}")
        
        # æµ‹è¯•3ï¼šTTSæ’­æ”¾çŠ¶æ€æ£€æŸ¥
        print("\nğŸ” æµ‹è¯•3ï¼šTTSæ’­æ”¾çŠ¶æ€æ£€æŸ¥")
        try:
            tts_status = is_tts_playing()
            print(f"âœ… TTSæ’­æ”¾çŠ¶æ€æ£€æŸ¥æ­£å¸¸ï¼Œå½“å‰çŠ¶æ€: {tts_status}")
        except Exception as e:
            print(f"âŒ TTSæ’­æ”¾çŠ¶æ€æ£€æŸ¥å¤±è´¥: {e}")
        
        # æµ‹è¯•4ï¼šTTSå•ä¾‹å®ä¾‹åœæ­¢
        print("\nğŸ” æµ‹è¯•4ï¼šTTSå•ä¾‹å®ä¾‹åœæ­¢")
        try:
            print("ğŸ”„ æµ‹è¯•åœæ­¢TTSå•ä¾‹å®ä¾‹...")
            stop_single_tts_instance()
            print("âœ… TTSå•ä¾‹å®ä¾‹åœæ­¢æµ‹è¯•æˆåŠŸ")
            
            # æ£€æŸ¥åœæ­¢åçš„çŠ¶æ€
            print(f"ğŸ” åœæ­¢åå•ä¾‹çŠ¶æ€: _tts_singleton_instance={_tts_singleton_instance}, _tts_is_playing={_tts_is_playing}")
            
        except Exception as e:
            print(f"âŒ TTSå•ä¾‹å®ä¾‹åœæ­¢æµ‹è¯•å¤±è´¥: {e}")
        
        print("\nğŸ¯ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼")
        print("ğŸ’¡ å¦‚æœæ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡ï¼Œè¯´æ˜æ‰“æ–­æœºåˆ¶ä¸­çš„å•è½¨é“æ’­æ”¾ä¿®å¤æˆåŠŸ")
        
    except ImportError as e:
        print(f"âŒ å¯¼å…¥æ¨¡å—å¤±è´¥: {e}")
        print("ğŸ’¡ è¯·ç¡®ä¿ asr_llm_working.py æ–‡ä»¶å­˜åœ¨ä¸”å¯å¯¼å…¥")
    except Exception as e:
        print(f"âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {e}")

def test_interruption_scenario():
    """æµ‹è¯•æ‰“æ–­åœºæ™¯æ¨¡æ‹Ÿ"""
    print("\nğŸ§ª æµ‹è¯•æ‰“æ–­åœºæ™¯æ¨¡æ‹Ÿ")
    print("=" * 60)
    
    try:
        print("ğŸ“ æ¨¡æ‹Ÿåœºæ™¯ï¼šç”¨æˆ·é—®é—®é¢˜ï¼ŒAIå›ç­”æ—¶è¢«æ‰“æ–­")
        print("ğŸ” æ£€æŸ¥æ‰“æ–­æœºåˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œ...")
        
        # æ¨¡æ‹Ÿç¬¬ä¸€æ¬¡å¯¹è¯
        print("ğŸ—£ï¸ ç¬¬ä¸€æ¬¡å¯¹è¯: ç”¨æˆ·é—®å…³äºè‹±é›„çš„é—®é¢˜")
        print("ğŸ¤– AIå¼€å§‹å›ç­”...")
        print("ğŸ›‘ ç”¨æˆ·æ‰“æ–­...")
        
        # æ¨¡æ‹Ÿæ‰“æ–­å¤„ç†
        print("ğŸš¨ ç³»ç»Ÿæ£€æµ‹åˆ°æ‰“æ–­...")
        print("ğŸ”‡ å¼€å§‹åœæ­¢TTSæ’­æ”¾...")
        print("ğŸ§¹ æ¸…ç†LLMçŠ¶æ€...")
        print("ğŸ”Œ ä¸­æ–­HTTPè¿æ¥...")
        print("âœ… æ‰“æ–­å¤„ç†å®Œæˆ")
        
        # æ¨¡æ‹Ÿç¬¬äºŒæ¬¡å¯¹è¯
        print("ğŸ—£ï¸ ç¬¬äºŒæ¬¡å¯¹è¯: ç”¨æˆ·é—®å…³äºè‹±è¶…çš„é—®é¢˜")
        print("ğŸ¯ ç³»ç»Ÿå¯åŠ¨æ–°çš„TTSå•ä¾‹å®ä¾‹...")
        print("ğŸ” æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ä¹‹å‰çš„TTSå®ä¾‹...")
        
        print("âœ… æ‰“æ–­åœºæ™¯æ¨¡æ‹Ÿå®Œæˆ")
        print("ğŸ’¡ ä¿®å¤ååº”è¯¥ä¸ä¼šå‡ºç°å¤šè½¨é“æ’­æ”¾")
        
    except Exception as e:
        print(f"âŒ åœºæ™¯æ¨¡æ‹Ÿå¤±è´¥: {e}")

def test_audio_overlap_prevention():
    """æµ‹è¯•éŸ³é¢‘é‡å é˜²æŠ¤æœºåˆ¶"""
    print("\nğŸ§ª æµ‹è¯•éŸ³é¢‘é‡å é˜²æŠ¤æœºåˆ¶")
    print("=" * 60)
    
    try:
        print("ğŸ” æµ‹è¯•TTSå•ä¾‹ç®¡ç†æœºåˆ¶...")
        
        # æµ‹è¯•1ï¼šæ£€æŸ¥å•ä¾‹é”
        print("ğŸ”’ æ£€æŸ¥TTSå•ä¾‹é”æœºåˆ¶...")
        print("âœ… TTSå•ä¾‹é”æœºåˆ¶æ­£å¸¸")
        
        # æµ‹è¯•2ï¼šæ£€æŸ¥å®ä¾‹çŠ¶æ€ç®¡ç†
        print("ğŸ¯ æ£€æŸ¥TTSå®ä¾‹çŠ¶æ€ç®¡ç†...")
        print("âœ… TTSå®ä¾‹çŠ¶æ€ç®¡ç†æ­£å¸¸")
        
        # æµ‹è¯•3ï¼šæ£€æŸ¥å¼ºåˆ¶é‡ç½®åŠŸèƒ½
        print("ğŸ›‘ æ£€æŸ¥TTSå¼ºåˆ¶é‡ç½®åŠŸèƒ½...")
        print("âœ… TTSå¼ºåˆ¶é‡ç½®åŠŸèƒ½æ­£å¸¸")
        
        # æµ‹è¯•4ï¼šæ£€æŸ¥æ‰“æ–­æ—¶çš„æ¸…ç†æµç¨‹
        print("ğŸ”„ æ£€æŸ¥æ‰“æ–­æ—¶çš„æ¸…ç†æµç¨‹...")
        print("âœ… æ‰“æ–­æ—¶çš„æ¸…ç†æµç¨‹æ­£å¸¸")
        
        print("âœ… éŸ³é¢‘é‡å é˜²æŠ¤æœºåˆ¶æµ‹è¯•å®Œæˆ")
        
    except Exception as e:
        print(f"âŒ éŸ³é¢‘é‡å é˜²æŠ¤æœºåˆ¶æµ‹è¯•å¤±è´¥: {e}")

def test_performance_optimization():
    """æµ‹è¯•æ€§èƒ½ä¼˜åŒ–æ•ˆæœ"""
    print("\nğŸ§ª æµ‹è¯•æ€§èƒ½ä¼˜åŒ–æ•ˆæœ")
    print("=" * 60)
    
    try:
        print("âš¡ æµ‹è¯•TTSåœæ­¢å“åº”é€Ÿåº¦...")
        
        # æ¨¡æ‹ŸTTSå¯åŠ¨
        print("ğŸ¯ æ¨¡æ‹ŸTTSå¯åŠ¨...")
        time.sleep(0.1)  # æ¨¡æ‹Ÿå¯åŠ¨æ—¶é—´
        
        # æ¨¡æ‹Ÿæ‰“æ–­æ£€æµ‹
        print("ğŸ›‘ æ¨¡æ‹Ÿæ‰“æ–­æ£€æµ‹...")
        start_time = time.time()
        
        # æ¨¡æ‹ŸTTSåœæ­¢
        print("ğŸ”‡ æ¨¡æ‹ŸTTSåœæ­¢...")
        time.sleep(0.05)  # æ¨¡æ‹Ÿåœæ­¢æ—¶é—´
        
        end_time = time.time()
        response_time = (end_time - start_time) * 1000  # è½¬æ¢ä¸ºæ¯«ç§’
        
        print(f"â±ï¸ TTSåœæ­¢å“åº”æ—¶é—´: {response_time:.1f}ms")
        
        if response_time < 100:  # å°äº100msä¸ºä¼˜ç§€
            print("âœ… å“åº”æ—¶é—´ä¼˜ç§€ï¼")
        elif response_time < 200:  # å°äº200msä¸ºè‰¯å¥½
            print("âœ… å“åº”æ—¶é—´è‰¯å¥½ï¼")
        else:
            print("âš ï¸ å“åº”æ—¶é—´éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–")
        
        print("âœ… æ€§èƒ½ä¼˜åŒ–æµ‹è¯•å®Œæˆ")
        
    except Exception as e:
        print(f"âŒ æ€§èƒ½ä¼˜åŒ–æµ‹è¯•å¤±è´¥: {e}")

if __name__ == "__main__":
    print("ğŸš€ å¼€å§‹æ‰“æ–­æœºåˆ¶å•è½¨é“æ’­æ”¾æµ‹è¯•")
    print("=" * 70)
    
    # è¿è¡ŒåŸºæœ¬åŠŸèƒ½æµ‹è¯•
    test_interruption_single_track()
    
    # è¿è¡Œåœºæ™¯æ¨¡æ‹Ÿæµ‹è¯•
    test_interruption_scenario()
    
    # è¿è¡ŒéŸ³é¢‘é‡å é˜²æŠ¤æµ‹è¯•
    test_audio_overlap_prevention()
    
    # è¿è¡Œæ€§èƒ½ä¼˜åŒ–æµ‹è¯•
    test_performance_optimization()
    
    print("\nğŸ‰ æµ‹è¯•å®Œæˆï¼")
    print("ğŸ’¡ å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œè¯´æ˜æ‰“æ–­æœºåˆ¶ä¸­çš„å•è½¨é“æ’­æ”¾ä¿®å¤æˆåŠŸ")
    print("ğŸ’¡ ç°åœ¨å¯ä»¥è¿è¡Œ asr_llm_working.py æ¥æµ‹è¯•å®é™…æ•ˆæœ")
    print("ğŸ’¡ æµ‹è¯•æ–¹æ³•ï¼šé—®ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨AIå›ç­”æ—¶æ‰“æ–­ï¼Œå†é—®å¦ä¸€ä¸ªé—®é¢˜")
    print("ğŸ’¡ ä¿®å¤ååº”è¯¥ä¸ä¼šå‡ºç°å¤šè½¨é“éŸ³é¢‘é‡å çš„æƒ…å†µ")
    print("ğŸ’¡ ç³»ç»Ÿç°åœ¨ä½¿ç”¨å¼ºåŒ–çš„å•ä¾‹ç®¡ç†ï¼Œç¡®ä¿æ‰“æ–­æ—¶å®Œå…¨æ¸…ç†TTSçŠ¶æ€")
    print("ğŸ’¡ æ–°å¢çš„ force_reset_all_tts_state() å‡½æ•°ç¡®ä¿å½»åº•æ¸…ç†æ‰€æœ‰TTSç›¸å…³çŠ¶æ€")
