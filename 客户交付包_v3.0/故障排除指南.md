# WebRTC语音助手系统 - 故障排除指南

## 🚨 常见问题及解决方案

### 1. 系统启动问题

#### 问题：ModuleNotFoundError
```
ModuleNotFoundError: No module named 'websockets'
```

**解决方案**：
```bash
# 安装缺失的依赖包
pip3 install websockets requests

# 或使用requirements.txt
pip3 install -r requirements.txt
```

#### 问题：端口被占用
```
Address already in use
```

**解决方案**：
```bash
# 查找占用端口的进程
lsof -i :8765  # macOS/Linux
netstat -an | findstr 8765  # Windows

# 结束进程
kill -9 <PID>
```

#### 问题：权限不足
```
Permission denied: start_webrtc_server.sh
```

**解决方案**：
```bash
# 给脚本执行权限
chmod +x start_webrtc_server.sh
```

### 2. 连接问题

#### 问题：客户端无法连接服务器
```
连接失败: WebSocket connection failed
```

**解决方案**：
1. 检查服务端是否启动
2. 确认端口8765是否开放
3. 检查防火墙设置
4. 尝试使用localhost而不是IP地址

#### 问题：WebSocket握手失败
```
WebSocket handshake failed
```

**解决方案**：
1. 检查浏览器版本（需要支持WebSocket）
2. 清除浏览器缓存
3. 尝试其他浏览器（Chrome/Edge推荐）

### 3. 音频问题

#### 问题：麦克风权限被拒绝
```
Microphone permission denied
```

**解决方案**：
1. 在浏览器地址栏点击麦克风图标
2. 选择"允许"
3. 刷新页面重新授权
4. 检查系统麦克风设置

#### 问题：没有声音输入
```
音频质量: 0%
```

**解决方案**：
1. 检查麦克风是否正常工作
2. 确认浏览器已获得麦克风权限
3. 检查系统音量设置
4. 尝试调整语音检测阈值

#### 问题：音频质量过低
```
音频质量: 15%
```

**解决方案**：
1. 调整语音检测阈值（在webrtc_client.html中）
2. 改善录音环境，减少背景噪音
3. 检查麦克风硬件质量
4. 调整音频缓冲区大小

### 4. ASR语音识别问题

#### 问题：ASR API连接失败
```
百度asr api连接失败
```

**解决方案**：
1. 检查网络连接
2. 确认百度API密钥有效
3. 检查API配额是否用完
4. 尝试重新获取访问令牌

#### 问题：ASR返回空结果
```
result: ['']
```

**解决方案**：
1. 检查音频数据是否有效
2. 确认音频格式支持（PCM/WAV）
3. 调整语音检测参数
4. 检查音频数据长度

#### 问题：语音被分段处理
```
一句话被分成两段处理
```

**解决方案**：
1. 调整语音结束检测时间（默认2秒）
2. 优化语音检测算法
3. 检查音频缓冲区设置

### 5. LLM大语言模型问题

#### 问题：LLM请求失败
```
LLM请求失败: name 'API_KEY' is not defined
```

**解决方案**：
1. 检查config.py中的API_KEY配置
2. 确认SiliconFlow API密钥有效
3. 检查网络连接
4. 验证API配额

#### 问题：LLM响应缓慢
```
响应时间超过30秒
```

**解决方案**：
1. 检查网络延迟
2. 调整请求超时时间
3. 确认API服务状态
4. 优化请求参数

### 6. TTS语音合成问题

#### 问题：TTS合成失败
```
TTS合成失败
```

**解决方案**：
1. 检查百度TTS API密钥
2. 确认网络连接
3. 检查文本内容是否合法
4. 尝试重新获取访问令牌

#### 问题：TTS音频播放失败
```
Decoding failed
```

**解决方案**：
1. 检查音频数据格式
2. 确认浏览器支持音频格式
3. 检查音频数据完整性
4. 尝试使用不同的音频格式

### 7. 性能问题

#### 问题：系统响应缓慢
```
语音输入到回复延迟过长
```

**解决方案**：
1. 检查系统资源使用情况
2. 优化音频缓冲区大小
3. 调整语音检测参数
4. 检查网络延迟

#### 问题：内存占用过高
```
内存使用率过高
```

**解决方案**：
1. 限制音频缓冲区大小
2. 及时清理断开的连接
3. 优化音频数据处理
4. 检查内存泄漏

## 🔧 调试技巧

### 1. 日志分析

#### 服务端日志
```bash
# 实时查看日志
tail -f webrtc_server.log

# 搜索特定错误
grep "ERROR" webrtc_server.log
grep "ASR" webrtc_server.log
grep "TTS" webrtc_server.log
```

#### 客户端日志
1. 按F12打开开发者工具
2. 查看Console标签页
3. 查看Network标签页的WebSocket连接
4. 检查音频相关错误

### 2. 网络诊断

#### 端口检查
```bash
# 检查端口是否开放
telnet localhost 8765

# 检查防火墙设置
sudo ufw status  # Ubuntu
sudo pfctl -s rules  # macOS
```

#### API连接测试
```bash
# 测试百度API连接
curl -X GET "https://aip.baidubce.com/oauth/2.0/token"

# 测试SiliconFlow API连接
curl -X GET "https://api.siliconflow.cn/v1/models"
```

### 3. 音频诊断

#### 音频设备检查
```bash
# macOS
system_profiler SPAudioDataType

# Linux
aplay -l
arecord -l

# Windows
# 在设备管理器中查看音频设备
```

#### 音频格式测试
```bash
# 使用ffmpeg测试音频
ffmpeg -i test.wav -f s16le -ar 16000 -ac 1 test.pcm
```

## 📞 获取帮助

### 1. 自助排查
1. 查看本文档
2. 检查系统日志
3. 运行测试脚本
4. 参考安装说明

### 2. 技术支持
- 记录详细的错误信息
- 提供系统环境信息
- 描述问题复现步骤
- 附上相关日志文件

### 3. 问题报告格式
```
问题描述：
环境信息：
错误日志：
复现步骤：
期望结果：
```

---
**记住**：大多数问题都可以通过仔细检查日志和配置来解决！ 🔍
